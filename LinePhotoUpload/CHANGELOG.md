# 修改記錄 - Line 照片上傳助理

## 版本 2.1.0 (2025-10-07)

### 🎯 重大變更

#### 1. 移除資料夾導航功能
- ❌ 移除階層式資料夾瀏覽功能
- ✅ 改為固定上傳到「Line相片上傳助手」資料夾
- ✅ 首次使用時自動創建該資料夾（如果不存在）
- ✅ 簡化用戶操作流程：直接傳送照片即可上傳

#### 2. 全新照片命名規則
- ✅ **優先使用 EXIF 拍攝日期**：從照片的 EXIF 資料中讀取原始拍攝時間
- ✅ **備用檔案建立日期**：如果照片沒有 EXIF 資料，則使用檔案建立時間
- ✅ **日期格式**：`YYYY-MM-DD_XXX.jpg`（例：`2025-10-07_001.jpg`）
- ✅ **每批從 001 開始**：每次上傳都從 001 開始編號，不會累加

#### 3. 檔名衝突防護機制 ⭐
- ✅ **上傳前檢查**：每次上傳前會檢查 Google Drive 中是否已有同名檔案
- ✅ **自動遞增編號**：如果 `2025-10-07_001.jpg` 已存在，自動使用 `002`、`003`...
- ✅ **絕對不覆蓋**：確保既有檔案永遠不會被覆蓋
- ✅ **安全上限**：最多支援到 9999，超過會提示錯誤

#### 4. 固定使用原始高畫質模式
- ✅ 移除模式切換功能
- ✅ 所有照片都以原始高畫質方式上傳

### 📝 修改的檔案

1. **package.json**
   - 新增依賴：`exif-parser` (用於讀取照片 EXIF 資料)

2. **messageController.js**
   - 大幅簡化：移除所有資料夾導航相關功能
   - 新增 `ensureUploadFolder()` 函數：自動確保上傳資料夾存在
   - 簡化指令：只保留 `hi`、`狀態`、`說明`

3. **photoService.js**
   - 新增 `extractPhotoDate()` 函數：讀取 EXIF 拍攝日期或檔案建立日期
   - 新增 `generateUniqueFileName()` 函數：生成唯一檔名並檢查衝突
   - 新增 `formatDate()` 函數：格式化日期為 YYYY-MM-DD
   - 修改 `processAndUpload()`：整合新的命名邏輯

4. **googleDriveService.js**
   - 新增 `checkFileExists()` 函數：檢查指定資料夾中是否存在同名檔案

5. **userStateService.js**
   - 大幅簡化：移除所有導航相關狀態
   - 保留基本功能：資料夾設定、照片計數

### 🔒 安全保證

✅ **檔名衝突檢查**：每個檔案上傳前都會檢查是否已存在
✅ **自動遞增編號**：發現重複時自動找下一個可用編號
✅ **不會覆蓋檔案**：絕對不會覆蓋 Google Drive 中的既有檔案
✅ **安全上限檢查**：編號超過 9999 時會拋出錯誤，防止無限迴圈

### 📸 使用方式

1. 加入 Line Bot
2. 直接傳送照片
3. 照片會自動上傳到「Line相片上傳助手」資料夾
4. 檔名格式：拍攝日期_編號（例：2025-10-07_001.jpg）

### 🔍 命名邏輯範例

#### 情境 1：全新照片
- 傳送一張 2025-10-07 拍攝的照片
- 檔名：`2025-10-07_001.jpg`

#### 情境 2：同一天稍後再上傳
- 再傳送 5 張 2025-10-07 拍攝的照片
- 系統檢查發現 `001` 已存在
- 自動使用：`002`、`003`、`004`、`005`、`006`

#### 情境 3：不同天的照片
- 傳送一張 2025-10-06 拍攝的照片
- 檔名：`2025-10-06_001.jpg`（不同日期，從 001 開始）

#### 情境 4：照片沒有 EXIF
- 傳送一張截圖或編輯過的照片（無 EXIF）
- 使用檔案建立時間作為日期
- 檔名：`2025-10-07_001.jpg`

### ⚙️ 部署步驟

1. 安裝新依賴：
```bash
cd LinePhotoUpload
npm install
```

2. 確認環境變數已設定（.env 或 Railway）：
```
LINE_CHANNEL_ACCESS_TOKEN=...
LINE_CHANNEL_SECRET=...
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GOOGLE_REFRESH_TOKEN=...
GOOGLE_REDIRECT_URI=...
PORT=3000
```

3. 重新部署到 Railway
```bash
git add .
git commit -m "更新到 v2.1.0 - 簡化功能並改善命名邏輯"
git push
```

### 🐛 已知限制

- 同一秒內上傳超過 9999 張同日期照片會報錯（實際上不太可能發生）
- EXIF 讀取僅支援標準 JPEG 格式
- PNG 或其他格式會使用檔案建立日期

---

**開發者**: cyclone-tw
**協助工具**: Claude Code

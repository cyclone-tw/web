<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Command - 終極客製版</title>
    <style>
        :root {
            --bg-color: #05050a;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-green: #39ff14;
            --neon-red: #ff3131;
            --turret-color: #ffd700;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color);
            color: #fff; font-family: 'Segoe UI', "Microsoft JhengHei", monospace;
            overflow: hidden; user-select: none; touch-action: manipulation;
        }

        #game-container {
            position: relative; width: 100%; max-width: 500px; height: 100vh;
            margin: 0 auto; background: radial-gradient(circle at center, #101025 0%, #05050a 100%);
            display: flex; flex-direction: column; border-left: 2px solid #222; border-right: 2px solid #222;
        }

        /* 頂部 HUD */
        #hud {
            display: flex; justify-content: space-between; padding: 15px;
            background: rgba(0,0,0,0.85); border-bottom: 2px solid var(--neon-blue); z-index: 100;
        }
        .stat { font-size: 1.1rem; font-weight: bold; text-shadow: 0 0 10px var(--neon-blue); }

        #battlefield { flex-grow: 1; position: relative; overflow: hidden; }

        /* 題目怪物 */
        .monster {
            position: absolute; width: 100px; height: 50px;
            background: rgba(0, 0, 0, 0.85); border: 2px solid var(--neon-blue);
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; font-weight: bold; color: var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue); pointer-events: none;
        }
        .monster.targeted {
            border: 3px solid var(--neon-pink);
            box-shadow: 0 0 20px var(--neon-pink);
            color: var(--neon-pink);
            z-index: 10;
        }

        /* 砲台 */
        #turret-base {
            position: absolute; bottom: 0px; left: 50%;
            width: 80px; height: 40px; background: #222;
            border-radius: 40px 40px 0 0; transform: translateX(-50%);
            border: 2px solid var(--turret-color); z-index: 50;
        }
        #turret-barrel {
            position: absolute; bottom: 30px; left: 50%;
            width: 12px; height: 45px; background: var(--turret-color);
            transform-origin: bottom center; transform: translateX(-50%) rotate(0deg);
            box-shadow: 0 0 15px var(--turret-color); border-radius: 5px; z-index: 49;
        }

        .bullet {
            position: absolute; width: 6px; height: 15px;
            background: var(--neon-green); border-radius: 3px;
            box-shadow: 0 0 10px var(--neon-green); z-index: 40;
        }

        /* 按鈕區 */
        #controls {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            padding: 15px; background: #000; border-top: 2px solid #333; z-index: 100;
        }
        .ans-btn {
            background: #111; border: 2px solid var(--neon-pink);
            color: var(--neon-pink); padding: 15px; font-size: 1.6rem;
            font-weight: bold; border-radius: 10px; cursor: pointer;
        }
        .ans-btn:active { background: var(--neon-pink); color: white; }

        /* 覆蓋層選單 */
        .overlay {
            position: absolute; inset: 0; background: rgba(5, 5, 15, 0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            z-index: 200; text-align: center; padding: 40px 20px; overflow-y: auto;
        }
        .hidden { display: none !important; }

        h1 { color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue); margin-bottom: 5px; }
        
        /* 設定選單樣式 */
        .config-card {
            width: 100%; max-width: 350px; background: rgba(255,255,255,0.05);
            padding: 20px; border-radius: 15px; margin-top: 20px; border: 1px solid #333;
        }
        h3 { color: var(--neon-pink); margin-top: 0; }
        .op-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .op-item {
            display: flex; align-items: center; background: #222;
            padding: 10px; border-radius: 8px; cursor: pointer;
        }
        .op-item input { margin-right: 10px; width: 18px; height: 18px; }

        .speed-labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-top: 5px; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--neon-green); }

        .btn-main {
            padding: 15px 60px; font-size: 1.5rem; background: var(--neon-green);
            border: none; border-radius: 40px; cursor: pointer; font-weight: bold;
            box-shadow: 0 0 20px var(--neon-green); margin-top: 25px;
        }

        #level-up-toast {
            position: absolute; top: 40%; width: 100%; text-align: center;
            font-size: 3rem; color: #ffff00; font-weight: bold;
            text-shadow: 0 0 20px yellow; pointer-events: none; z-index: 150;
            display: none;
        }

        #review-container { width: 100%; max-height: 250px; overflow-y: auto; margin: 20px 0; border: 1px solid #444; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #333; padding: 10px; text-align: center; font-size: 0.9rem; }
        th { background: #222; color: var(--neon-blue); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="hud">
        <div class="stat">HP: <span id="hp">5</span></div>
        <div class="stat">LV: <span id="lv">1</span></div>
        <div class="stat">進度: <span id="prog">0/50</span></div>
    </div>

    <div id="battlefield">
        <div id="turret-base"></div>
        <div id="turret-barrel"></div>
        <div id="level-up-toast">LEVEL UP!</div>
    </div>

    <div id="controls">
        <button class="ans-btn" onclick="Game.fire(this)">-</button>
        <button class="ans-btn" onclick="Game.fire(this)">-</button>
        <button class="ans-btn" onclick="Game.fire(this)">-</button>
        <button class="ans-btn" onclick="Game.fire(this)">-</button>
    </div>

    <!-- 初始選單畫面 -->
    <div id="start-screen" class="overlay">
        <h1>MATH COMMAND</h1>
        <p style="color: #888;">自訂你的戰鬥模式</p>

        <div class="config-card">
            <h3>1. 選擇運算類型</h3>
            <div class="op-grid">
                <label class="op-item"><input type="checkbox" class="op-check" value="+" checked>加法 (+)</label>
                <label class="op-item"><input type="checkbox" class="op-check" value="-" checked>減法 (-)</label>
                <label class="op-item"><input type="checkbox" class="op-check" value="*" checked>乘法 (×)</label>
                <label class="op-item"><input type="checkbox" class="op-check" value="/" checked>除法 (÷)</label>
            </div>

            <h3>2. 初始掉落速度</h3>
            <input type="range" id="speed-slider" min="0.2" max="1.5" step="0.1" value="0.5">
            <div class="speed-labels">
                <span>緩慢</span>
                <span>標準</span>
                <span>快速</span>
            </div>
        </div>

        <button class="btn-main" onclick="Game.prepareGame()">啟動砲台</button>
    </div>

    <!-- 結算畫面 -->
    <div id="end-screen" class="overlay hidden">
        <h2 id="end-title">任務結束</h2>
        <div id="review-container">
            <table>
                <thead><tr><th>題目</th><th>你的答案</th><th>正確</th></tr></thead>
                <tbody id="review-body"></tbody>
            </table>
        </div>
        <button class="btn-main" onclick="location.reload()">回主選單</button>
    </div>
</div>

<script>
/**
 * 音效引擎
 */
const Sound = {
    ctx: null,
    setup() {
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (this.ctx.state === 'suspended') this.ctx.resume();
    },
    play(type) {
        if (!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        const now = this.ctx.currentTime;
        if (type === 'shoot') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.exponentialRampToValueAtTime(110, now + 0.1);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if (type === 'exp') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(80, now);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(); osc.stop(now + 0.2);
        } else if (type === 'hit') {
            osc.frequency.setValueAtTime(150, now);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(); osc.stop(now + 0.2);
        }
    }
};

/**
 * 遊戲主要邏輯
 */
const Game = {
    hp: 5,
    level: 1,
    solvedCount: 0,
    totalToWin: 50,
    monsters: [],
    bullets: [],
    wrongRecords: [],
    lastSpawnTime: 0,
    gameActive: false,
    
    // 自訂參數
    selectedOps: [],
    baseSpeed: 0.5,
    currentSpeed: 0.5,
    spawnInterval: 3500,

    prepareGame() {
        const checks = document.querySelectorAll('.op-check:checked');
        this.selectedOps = Array.from(checks).map(c => c.value);
        
        if (this.selectedOps.length === 0) {
            alert("請至少選擇一種運算類型！");
            return;
        }

        this.baseSpeed = parseFloat(document.getElementById('speed-slider').value);
        this.currentSpeed = this.baseSpeed;
        this.spawnInterval = 4000 - (this.baseSpeed * 1000); // 根據基礎速度調整產怪頻率

        this.init();
    },

    init() {
        Sound.setup();
        document.getElementById('start-screen').classList.add('hidden');
        this.gameActive = true;
        this.lastSpawnTime = Date.now();
        this.loop();
    },

    generateMath() {
        const op = this.selectedOps[Math.floor(Math.random() * this.selectedOps.length)];
        let a, b, ans, q;

        if (op === '+') {
            ans = Math.floor(Math.random() * 81) + 10;
            a = Math.floor(Math.random() * (ans - 5)) + 2;
            b = ans - a;
            q = `${a}+${b}`;
        } else if (op === '-') {
            a = Math.floor(Math.random() * 80) + 20;
            b = Math.floor(Math.random() * (a - 5)) + 2;
            ans = a - b;
            q = `${a}-${b}`;
        } else if (op === '*') {
            a = Math.floor(Math.random() * 8) + 2;
            b = Math.floor(Math.random() * Math.floor(100/a)) + 1;
            ans = a * b;
            q = `${a}×${b}`;
        } else {
            const quot = Math.floor(Math.random() * 10) + 1;
            b = Math.floor(Math.random() * 9) + 2;
            a = quot * b;
            ans = quot;
            q = `${a}÷${b}`;
        }
        return { q, ans };
    },

    spawnMonster() {
        if (this.solvedCount + this.monsters.length >= this.totalToWin + 5) return;

        const data = this.generateMath();
        const el = document.createElement('div');
        el.className = 'monster';
        el.innerText = data.q;
        
        const battlefield = document.getElementById('battlefield');
        const x = Math.random() * (battlefield.offsetWidth - 120) + 10;
        el.style.left = x + 'px';
        el.style.top = '-60px';
        battlefield.appendChild(el);

        const choices = [data.ans];
        while(choices.length < 4) {
            let offset = Math.floor(Math.random() * 10) - 5;
            if (offset === 0) offset = 2;
            let val = data.ans + offset;
            if (val >= 0 && !choices.includes(val)) choices.push(val);
        }

        this.monsters.push({
            el: el,
            ans: data.ans,
            q: data.q,
            x: x + 50,
            y: -60,
            choices: choices.sort(() => Math.random() - 0.5)
        });
    },

    update() {
        if (!this.gameActive) return;

        const now = Date.now();
        if (now - this.lastSpawnTime > this.spawnInterval) {
            this.spawnMonster();
            this.lastSpawnTime = now;
        }

        const fieldH = document.getElementById('battlefield').offsetHeight;
        let targetIdx = -1;
        let lowestY = -1000;

        // 更新怪物
        for (let i = this.monsters.length - 1; i >= 0; i--) {
            const m = this.monsters[i];
            m.y += this.currentSpeed;
            m.el.style.top = m.y + 'px';
            m.el.classList.remove('targeted');

            if (m.y > fieldH - 85) {
                this.recordError(m.q, "漏掉", m.ans);
                m.el.remove();
                this.monsters.splice(i, 1);
                this.takeDamage();
                continue;
            }

            if (m.y > lowestY) {
                lowestY = m.y;
                targetIdx = i;
            }
        }

        // 自動瞄準最近目標
        if (targetIdx !== -1) {
            const target = this.monsters[targetIdx];
            target.el.classList.add('targeted');
            this.aimAt(target);
            this.updateButtons(target.choices);
        } else {
            this.updateButtons(["?", "?", "?", "?"]);
        }

        // 更新砲彈
        for (let i = this.bullets.length - 1; i >= 0; i--) {
            const b = this.bullets[i];
            b.x += b.vx;
            b.y += b.vy;
            b.el.style.left = b.x + 'px';
            b.el.style.top = b.y + 'px';

            const targetMonster = this.monsters.find(m => m === b.target);
            if (targetMonster) {
                const dx = b.x - targetMonster.x;
                const dy = b.y - (targetMonster.y + 25);
                if (Math.sqrt(dx*dx + dy*dy) < 35) {
                    Sound.play('exp');
                    targetMonster.el.remove();
                    this.monsters = this.monsters.filter(m => m !== targetMonster);
                    b.el.remove();
                    this.bullets.splice(i, 1);
                    this.onSolved();
                    continue;
                }
            }

            if (b.y < -50 || b.x < -50 || b.x > 600) {
                b.el.remove();
                this.bullets.splice(i, 1);
            }
        }
    },

    aimAt(target) {
        const barrel = document.getElementById('turret-barrel');
        const field = document.getElementById('battlefield');
        const centerX = field.offsetWidth / 2;
        const centerY = field.offsetHeight - 20;
        
        const dx = target.x - centerX;
        const dy = (target.y + 25) - centerY;
        const angle = Math.atan2(dx, -dy) * (180 / Math.PI);
        barrel.style.transform = `translateX(-50%) rotate(${angle}deg)`;
    },

    updateButtons(choices) {
        const btns = document.querySelectorAll('.ans-btn');
        btns.forEach((btn, i) => {
            btn.innerText = choices[i];
            btn.dataset.val = choices[i];
        });
    },

    fire(btn) {
        if (!this.gameActive) return;
        
        // 取得鎖定目標 (最下方)
        const target = this.monsters.reduce((prev, curr) => (curr.y > prev.y ? curr : prev), {y: -1000});
        if (!target.el) return;

        const userVal = parseInt(btn.dataset.val);
        if (userVal === target.ans) {
            Sound.play('shoot');
            this.createBullet(target);
        } else {
            this.recordError(target.q, userVal, target.ans);
            this.takeDamage();
        }
    },

    createBullet(target) {
        const field = document.getElementById('battlefield');
        const startX = field.offsetWidth / 2;
        const startY = field.offsetHeight - 40;
        
        const el = document.createElement('div');
        el.className = 'bullet';
        el.style.left = startX + 'px';
        el.style.top = startY + 'px';
        field.appendChild(el);

        const dx = target.x - startX;
        const dy = (target.y + 25) - startY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const speed = 20;

        this.bullets.push({
            el: el,
            x: startX, y: startY,
            vx: (dx / dist) * speed,
            vy: (dy / dist) * speed,
            target: target
        });
    },

    takeDamage() {
        Sound.play('hit');
        this.hp--;
        document.getElementById('hp').innerText = this.hp;
        document.getElementById('battlefield').style.backgroundColor = 'rgba(255,0,0,0.2)';
        setTimeout(() => document.getElementById('battlefield').style.backgroundColor = 'transparent', 150);
        
        if (this.hp <= 0) this.gameOver("戰線崩潰！");
    },

    onSolved() {
        this.solvedCount++;
        document.getElementById('prog').innerText = `${this.solvedCount}/${this.totalToWin}`;
        if (this.solvedCount % 10 === 0) this.levelUp();
        if (this.solvedCount >= this.totalToWin) this.gameOver("防線勝利！");
    },

    levelUp() {
        this.level++;
        document.getElementById('lv').innerText = this.level;
        // 難度提升：速度增加，間隔縮短
        this.currentSpeed += 0.15;
        this.spawnInterval = Math.max(1000, this.spawnInterval - 300);
        
        const toast = document.getElementById('level-up-toast');
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 1000);
    },

    recordError(q, user, correct) {
        this.wrongRecords.push({ q, user, correct });
    },

    gameOver(title) {
        this.gameActive = false;
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('end-title').innerText = title;
        const body = document.getElementById('review-body');
        body.innerHTML = this.wrongRecords.map(r => 
            `<tr><td>${r.q}</td><td style="color:var(--neon-red)">${r.user}</td><td style="color:var(--neon-green)">${r.correct}</td></tr>`
        ).join('') || '<tr><td colspan="3">零失誤！你是天才！</td></tr>';
    },

    loop() {
        if (this.gameActive) {
            this.update();
            requestAnimationFrame(() => this.loop());
        }
    }
};
</script>
</body>
</html>